<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="shortcut icon" type="image/png" href="https://upload.wikimedia.org/wikipedia/commons/thumb/4/44/Microsoft_logo.svg/2000px-Microsoft_logo.svg.png">

  <title>
    
      R Perform customer clustering
    
  </title>
  <meta name="description" content="Get Started with SQL Server Machine Learning Services">
  <link rel="stylesheet" href="/en-us/sql-server/developer-get-started/ml-tutorials/assets/main.css">
  <link rel="canonical" href="https://sqlchoice.azurewebsites.net/en-us/sql-server/developer-get-started/ml-tutorials/R/customerclustering/step/2">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>

  
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-62780441-15', 'auto');
  ga('send', 'pageview');
  $(document).ready(function() {
      $("code").bind({
          copy: function(event) {
              ga("send", "event", {
                  eventCategory: window.location.pathname,
                  eventAction: "copy_code"
              });
         console.log("Copy");

          }, 

          cut: function(event) {
              ga("send", "event", {
                  eventCategory: window.location.pathname,
                  eventAction: "copy_code"
              });
          }
      })

      $("a").click(function(event) {
          ga("send", "event", {
              eventCategory: window.location.pathname,
              eventAction: "click_link",
              eventLabel: event.target.href
          });
      })
  });  
  </script>



</head>


  <body>

    <header class="sql-header sql-header--empty" role="banner">
    <div class="sql-header-content">
      <img class="sql-header-micro" src="/en-us/sql-server/developer-get-started/ml-tutorials/assets/images/micro-logo.png" alt="Microsoft logo">
      
        <div class="sql-menutop">
          <a class="sql-menutop-link" href="/en-us/sql-server/developer-get-started/ml-tutorials/">Get started with Machine Learning in SQL Server</a>
          <div>
            
              
              

              <div class="sql-menutop-sub  is-active ">
                  
                    
                      
                      

                        
                          <span class="sql-menutop-link">R </span>
                        

                        
                    
                      
                      

                        

                        
                          <div class="sql-menutop-items">
                            
                              
                              
                              

                              <a class="sql-menutop-item " 
                                href="/en-us/sql-server/developer-get-started/ml-tutorials/R/rentalprediction" 
                                target="_self">
                                Predict ski rentals
                                
                              </a>
                            
                              
                              
                              

                              <a class="sql-menutop-item  is-active " 
                                href="/en-us/sql-server/developer-get-started/ml-tutorials/R/customerclustering" 
                                target="_self">
                                Perform customer clustering
                                
                              </a>
                            
                          </div>
                        
                    
                  
              </div>
            
              
              

              <div class="sql-menutop-sub ">
                  
                    
                      
                      

                        
                          <span class="sql-menutop-link">Python </span>
                        

                        
                    
                      
                      

                        

                        
                          <div class="sql-menutop-items">
                            
                              
                              
                              

                              <a class="sql-menutop-item " 
                                href="/en-us/sql-server/developer-get-started/ml-tutorials/python/rentalprediction" 
                                target="_self">
                                Predict ski rentals
                                
                              </a>
                            
                              
                              
                              

                              <a class="sql-menutop-item " 
                                href="/en-us/sql-server/developer-get-started/ml-tutorials/python/customerclustering" 
                                target="_self">
                                Perform customer clustering
                                
                                  <i class="sql-new"></i>
                                
                              </a>
                            
                          </div>
                        
                    
                  
              </div>
            
          </div>
        </div>

      
</header>


    <main class="sql-main" aria-label="Content">
      <div class="u-wrapper">
        <article class="sql-page_steps">

  
    
    
    

    <h1 class="sql-page_steps-hero">
      Perform customer clustering using R and SQL Server ML Services
    </h1>

    <header class="sql-page_steps-steps js-stepsheader">
      
        
        

        <div class="sql-page_steps-step">
          
            <a class="sql-page_steps-link "
               href="/en-us/sql-server/developer-get-started/ml-tutorials/R/customerclustering"
               target="_self">
               <span class="sql-page_steps-number">1</span>
               Set up your environment
              </a>
          
        </div>
      
        
        

        <div class="sql-page_steps-step">
          
            <a class="sql-page_steps-link  sql-page_steps-link--active "
               href="/en-us/sql-server/developer-get-started/ml-tutorials/R/customerclustering/step/2.html"
               target="_self">
               <span class="sql-page_steps-number">2</span>
               Create your ML script using R
            </a>
          
        </div>
      
        
        

        <div class="sql-page_steps-step">
          
            <a class="sql-page_steps-link "
               href="/en-us/sql-server/developer-get-started/ml-tutorials/R/customerclustering/step/3.html"
               target="_self">
               <span class="sql-page_steps-number">3</span>
               Deploy your ML script with SQL Server
            </a>
          
        </div>
      
    </header>
  

  <div class="sql-page_steps-loading js-loading">
    <p></p>
    <p></p>
    <p></p>
    <p></p>
    <div></div>
    <div></div>
    <p></p>
    <div></div>
    <div></div>
    <p></p>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <p></p>
    <p></p>
    <div></div>
    <div></div>
    <div></div>
    <p></p>
    <div></div>
    <div></div>
    <p></p>
    <p></p>
    <div></div>
    <div></div>
    
  </div>

  <div class="js-steps is-hidden">
    <blockquote>
  <p>After getting SQL Server with Machine Learning Services installed and your R IDE configured on your machine, you can now proceed and perform clustering using R.</p>
</blockquote>

<blockquote>
  <p>R is a programming language that makes statistical and math computation easy, and is very useful for any machine learning/predictive analytics/statistics work. There are lots of tutorials out there on R. This is one example of a <a href="https://www.tutorialspoint.com/r/">tutorial</a> to learn more about R.</p>
</blockquote>

<blockquote>
  <p>In this specific scenario, we have an online store and we want to group customers based on their order and return behaviour. 
This information will help us target marketing efforts towards certain groups of customers. Before we go into how you can use R to perform this type of customer grouping using clustering in SQL Server 2016, we will look at the scenario in R.</p>
</blockquote>

<h2 id="step-21-load-the-sample-data">Step 2.1 Load the sample data</h2>

<p><strong>Restore the sample DB</strong>
The dataset used in this tutorial is hosted in several SQL Server tables.The tables contain purchasing and return data based on orders.</p>

<ol>
  <li>
    <p>Download the backup (.bak) file <a href="https://sqlchoice.blob.core.windows.net/sqlchoice/static/tpcxbb_1gb.bak">here</a>, and save it on a location that SQL Server can access.
For example in the folder where SQL Server is installed.
Sample path: C:\Program Files\Microsoft SQL Server\MSSQL13.MSSQLSERVER\MSSQL\Backup</p>
  </li>
  <li>
    <p>Once you have the file saved, open SSMS and a new query window to run the following commands to restore the DB.
Make sure to modify the file paths and server name in the script.</p>
  </li>
</ol>

<div class="language-sql highlighter-rouge"><pre class="highlight"><code><span class="n">USE</span> <span class="n">master</span><span class="p">;</span>  
<span class="k">GO</span>  
<span class="n">RESTORE</span> <span class="k">DATABASE</span> <span class="n">tpcxbb_1gb</span>  
   <span class="k">FROM</span> <span class="n">DISK</span> <span class="o">=</span> <span class="s1">'C:</span><span class="se">\P</span><span class="s1">rogram Files</span><span class="se">\M</span><span class="s1">icrosoft SQL Server</span><span class="se">\M</span><span class="s1">SSQL13.MSSQLSERVER</span><span class="se">\M</span><span class="s1">SSQL</span><span class="se">\B</span><span class="s1">ackup</span><span class="se">\t</span><span class="s1">pcxbb_1gb.bak'</span>
   <span class="k">WITH</span> 
                <span class="k">MOVE</span> <span class="s1">'tpcxbb_1gb'</span> <span class="k">TO</span> <span class="s1">'C:</span><span class="se">\P</span><span class="s1">rogram Files</span><span class="se">\M</span><span class="s1">icrosoft SQL Server</span><span class="se">\M</span><span class="s1">SSQL13.MSSQLSERVER</span><span class="se">\M</span><span class="s1">SSQL</span><span class="se">\D</span><span class="s1">ATA</span><span class="se">\t</span><span class="s1">pcxbb_1gb.mdf'</span>
                <span class="p">,</span><span class="k">MOVE</span> <span class="s1">'tpcxbb_1gb_log'</span> <span class="k">TO</span> <span class="s1">'C:</span><span class="se">\P</span><span class="s1">rogram Files</span><span class="se">\M</span><span class="s1">icrosoft SQL Server</span><span class="se">\M</span><span class="s1">SSQL13.MSSQLSERVER</span><span class="se">\M</span><span class="s1">SSQL</span><span class="se">\D</span><span class="s1">ATA</span><span class="se">\t</span><span class="s1">pcxbb_1gb.ldf'</span><span class="p">;</span>  
<span class="k">GO</span>  
</code></pre>
</div>

<p>You should now be able to see the database and tables store_sales and store_returns in the Object Explorer in SSMS.
You can also verify this by querying the tables in SSMS. Open a new query window and select the following.</p>

<div class="language-sql highlighter-rouge"><pre class="highlight"><code><span class="n">USE</span> <span class="n">tpcxbb_1gb</span><span class="p">;</span>
<span class="k">SELECT</span> <span class="n">TOP</span> <span class="p">(</span><span class="mi">100</span><span class="p">)</span> <span class="o">*</span> <span class="k">FROM</span> <span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">store_sales</span><span class="p">];</span>
<span class="k">SELECT</span> <span class="n">TOP</span> <span class="p">(</span><span class="mi">100</span><span class="p">)</span> <span class="o">*</span> <span class="k">FROM</span> <span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">store_returns</span><span class="p">];</span>
</code></pre>
</div>

<blockquote>
  <p>You now have the database and the data to perform clustering.</p>
</blockquote>

<h2 id="step-22-access-the-data-from-sql-server-using-r">Step 2.2 Access the data from SQL Server using R</h2>

<p>Loading data from SQL Server to R is easy. So let’s try it out.</p>

<p>Open a new RScript in your R development tool and run the following script.
Just don’t forget to replace “MYSQLSERVER” with the name of your database instance.</p>

<p>In the query we are using to select data from SQL Server, we are separating customers along the following dimensions:</p>
<ul>
  <li><em>return frequency</em></li>
  <li><em>return order ratio (total number of orders partially or fully returned versus the total number of orders)</em></li>
  <li><em>return item ratio (total number of items returned versus the number of items purchased)</em></li>
  <li><em>return amount ration (total monetary amount of items returned versus the amount purchased)</em></li>
</ul>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="c1">#Connection string to connect to SQL Server. Don't forget to replace MyServer with the name of your SQL Server instance
</span><span class="n">connStr</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">paste</span><span class="p">(</span><span class="s2">"Driver=SQL Server;Server="</span><span class="p">,</span><span class="w"> </span><span class="s2">" MyServer"</span><span class="p">,</span><span class="w"> </span><span class="s2">";Database="</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="s2">"tpcxbb_1gb"</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="s2">";Trusted_Connection=true;"</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="n">sep</span><span class="o">=</span><span class="s2">""</span><span class="w"> </span><span class="p">);</span><span class="w">

</span><span class="c1">#The query that we are using to select data from SQL Server
</span><span class="n">input_query</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s2">"
	SELECT
  ss_customer_sk AS customer,
  round(CASE WHEN ((orders_count = 0) OR (returns_count IS NULL) OR (orders_count IS NULL) OR ((returns_count / orders_count) IS NULL) ) THEN 0.0 ELSE (cast(returns_count as nchar(10)) / orders_count) END, 7) AS orderRatio,
  round(CASE WHEN ((orders_items = 0) OR(returns_items IS NULL) OR (orders_items IS NULL) OR ((returns_items / orders_items) IS NULL) ) THEN 0.0 ELSE (cast(returns_items as nchar(10)) / orders_items) END, 7) AS itemsRatio,
  round(CASE WHEN ((orders_money = 0) OR (returns_money IS NULL) OR (orders_money IS NULL) OR ((returns_money / orders_money) IS NULL) ) THEN 0.0 ELSE (cast(returns_money as nchar(10)) / orders_money) END, 7) AS monetaryRatio,
  round(CASE WHEN ( returns_count IS NULL                                                                        ) THEN 0.0 ELSE  returns_count                 END, 0) AS frequency
  --cast(round(cast(CASE WHEN (returns_count IS NULL) THEN 0.0 ELSE  returns_count END as double)) as integer) AS frequency
FROM
  (
    SELECT
      ss_customer_sk,
      -- return order ratio
      COUNT(distinct(ss_ticket_number)) AS orders_count,
      -- return ss_item_sk ratio
      COUNT(ss_item_sk) AS orders_items,
      -- return monetary amount ratio
      SUM( ss_net_paid ) AS orders_money
    FROM store_sales s
    GROUP BY ss_customer_sk
  ) orders
  LEFT OUTER JOIN
  (
    SELECT
      sr_customer_sk,
      -- return order ratio
      count(distinct(sr_ticket_number)) as returns_count,
      -- return ss_item_sk ratio
      COUNT(sr_item_sk) as returns_items,
      -- return monetary amount ratio
      SUM( sr_return_amt ) AS returns_money
    FROM store_returns
    GROUP BY sr_customer_sk
  ) returned ON ss_customer_sk=sr_customer_sk
"</span><span class="w">
</span></code></pre>
</div>

<p>Results from the query are returned to R using the rxSqlServerData function. 
This is also where we define the type for columns we want to select (using colClasses), to make sure that the types are correctly transferred to R.</p>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="c1">#Querying SQL Server using the query above and and getting the results back to data frame customer_returns
#This is also where we define the type for columns we want to select (using colClasses), to make sure that the types are correctly transferred to R
</span><span class="n">customer_returns</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">RxSqlServerData</span><span class="p">(</span><span class="n">sqlQuery</span><span class="o">=</span><span class="n">input_query</span><span class="p">,</span><span class="n">colClasses</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="n">customer</span><span class="w"> </span><span class="o">=</span><span class="s2">"numeric"</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="n">orderRatio</span><span class="o">=</span><span class="s2">"numeric"</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="n">itemsRatio</span><span class="o">=</span><span class="s2">"numeric"</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="n">monetaryRatio</span><span class="o">=</span><span class="s2">"numeric"</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="n">frequency</span><span class="o">=</span><span class="s2">"numeric"</span><span class="w"> </span><span class="p">),</span><span class="n">connectionString</span><span class="o">=</span><span class="n">connStr</span><span class="p">);</span><span class="w">
                
</span><span class="c1"># Transform the data from an input dataset to an output dataset
</span><span class="n">customer_data</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">rxDataStep</span><span class="p">(</span><span class="n">customer_returns</span><span class="p">);</span><span class="w">
                
</span><span class="c1">#Look at the data we just loaded from SQL Server
</span><span class="n">head</span><span class="p">(</span><span class="n">customer_data</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">5</span><span class="p">);</span><span class="w">
</span></code></pre>
</div>
<pre><code class="language-results">customer orderRatio itemsRatio monetaryRatio frequency
1    75675          0          0      0.071633         4
2    86750          0          0      0.000000         0
3    75343          0          0      0.000000         0
4    49280          0          0      0.000000         0
5    89406          0          0      0.000000         0
6    72426          0          0      0.000000         0
</code></pre>

<blockquote>
  <p>You have now read the data from SQL Server to R and explored it.</p>
</blockquote>

<h2 id="step-23-determine-number-of-clusters">Step 2.3 Determine number of clusters</h2>

<p>Using the clustering algorithm <strong>Kmeans</strong>, is one of the simplest and most well known ways of grouping data.
Now that we have our selected data, we can group the data into clusters using the iterative data mining algorithm called Kmeans.</p>

<p>The algorithm accepts two inputs: The data itself, and a predefined number “k”, the number of clusters.
The output is k clusters with input data partitioned among them.</p>

<p>The goal of K-means is to group the items into k clusters such that all items in same cluster are as similar to each other as possible. And items not in same cluster are as different as possible.
It uses the distance measures to calculate similarity and dissimilarity.</p>

<p>This is how the algorithm works:</p>

<ol>
  <li>It randomly chooses k points and make them the initial centroids (each cluster has a centroid which basically is the “center” of the cluster)</li>
  <li>For each point, it finds the nearest centroid and assigns the point to the cluster associated with the nearest centroid</li>
  <li>Updates the centroid of each cluster based on members in that cluster. Typically, a new centroid will be the average of all members in the cluster</li>
  <li>Repeats steps 2 and 3, until the clusters are stable</li>
</ol>

<p>The number of clusters has to be predefined and the quality of the clusters is heavily dependent on the correctness of the k value specified.
You could just randomly pick a number of clusters, run Kmeans and iterate your way to a good number. 
Or we can use R to evaluate which number of clusters is best for our dataset. Let’s determine the number of clusters using R!</p>
<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="c1">#Determine number of clusters
#Using a plot of the within groups sum of squares, by number of clusters extracted, can help determine the appropriate number of clusters
#We are looking for a bend in the plot. It is at this "elbow" in the plot that we have the appropriate number of clusters 
</span><span class="n">wss</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="p">(</span><span class="n">nrow</span><span class="p">(</span><span class="n">customer_data</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">apply</span><span class="p">(</span><span class="n">customer_data</span><span class="p">,</span><span class="w"> </span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="n">var</span><span class="p">))</span><span class="w">
       </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">2</span><span class="o">:</span><span class="m">20</span><span class="p">)</span><span class="w">
       </span><span class="n">wss</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">kmeans</span><span class="p">(</span><span class="n">customer_data</span><span class="p">,</span><span class="w"> </span><span class="n">centers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="p">)</span><span class="o">$</span><span class="n">withinss</span><span class="p">)</span><span class="w">
</span><span class="n">plot</span><span class="p">(</span><span class="m">1</span><span class="o">:</span><span class="m">20</span><span class="p">,</span><span class="w"> </span><span class="n">wss</span><span class="p">,</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"b"</span><span class="p">,</span><span class="w"> </span><span class="n">xlab</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Number of Clusters"</span><span class="p">,</span><span class="w"> </span><span class="n">ylab</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Within groups sum of squares"</span><span class="p">)</span><span class="w">
</span></code></pre>
</div>

<p><img src="https://sqlchoice.blob.core.windows.net/sqlchoice/static/images/Elbow_graph.JPG" alt="Elbow graph" />
Finding the right number of clusters using an elbow graph</p>

<p>Based on the graph above, it looks like <em>k = 4</em> would be a good value to try. That will group our customers into 4 clusters.</p>

<blockquote>
  <p>Now we have derived the number of clusters to use when clustering.</p>
</blockquote>

<h2 id="step-24-perform-clustering">Step 2.4 Perform Clustering</h2>
<p>Now it is time to use Kmeans. In this sample, we will be using the function rxKmeans which is the Kmeans function in the RevoScaleR package.</p>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="c1"># Output table to hold the customer group mappings. This is a table where the cluster mappings will be saved in the database. 
# This table is generated from R
</span><span class="n">return_cluster</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">RxSqlServerData</span><span class="p">(</span><span class="n">table</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"return_cluster"</span><span class="p">,</span><span class="w"> </span><span class="n">connectionString</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">connStr</span><span class="p">);</span><span class="w">
</span><span class="c1"># Set.seed for random number generator for predictability
</span><span class="n">set.seed</span><span class="p">(</span><span class="m">10</span><span class="p">);</span><span class="w">
</span><span class="c1"># Generate clusters using rxKmeans and output key / cluster to a table in SQL Server called return_cluster
</span><span class="n">clust</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">rxKmeans</span><span class="p">(</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">orderRatio</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">itemsRatio</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">monetaryRatio</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">frequency</span><span class="p">,</span><span class="w"> </span><span class="n">customer_returns</span><span class="p">,</span><span class="w"> </span><span class="n">numClusters</span><span class="o">=</span><span class="m">4</span><span class="w">
         </span><span class="p">,</span><span class="w"> </span><span class="n">outFile</span><span class="o">=</span><span class="n">return_cluster</span><span class="p">,</span><span class="w"> </span><span class="n">outColName</span><span class="o">=</span><span class="s2">"cluster"</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="n">extraVarsToWrite</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="s2">"customer"</span><span class="p">),</span><span class="w"> </span><span class="n">overwrite</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">);</span><span class="w">

</span><span class="c1"># Read the customer returns cluster table from the DB
</span><span class="n">customer_cluster</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">rxDataStep</span><span class="p">(</span><span class="n">return_cluster</span><span class="p">);</span><span class="w">

</span></code></pre>
</div>

<blockquote>
  <p>Great, now you have performed clustering in R!</p>
</blockquote>

<h2 id="step-25-analyze-results---plot-clusters">Step 2.5 Analyze results - Plot clusters</h2>

<p>R is very useful since it’s easy to plot and visualize data for analysis. Now that we have done the clustering using Kmeans, we need to analyze it and see if we can learn anything from it. Sometimes plotting the clusters might be helpful, so let’s do that.</p>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="c1">#Plot the clusters (you need to install R library "cluster". If you don't have that installed, just uncomment the next line of code)
#install.packages("cluster")
</span><span class="n">library</span><span class="p">(</span><span class="s2">"cluster"</span><span class="p">);</span><span class="w">
</span><span class="n">clusplot</span><span class="p">(</span><span class="n">customer_data</span><span class="p">,</span><span class="w"> </span><span class="n">customer_cluster</span><span class="o">$</span><span class="n">cluster</span><span class="p">,</span><span class="w"> </span><span class="n">color</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">,</span><span class="w"> </span><span class="n">shade</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">,</span><span class="w"> </span><span class="n">labels</span><span class="o">=</span><span class="m">4</span><span class="p">,</span><span class="w"> </span><span class="n">lines</span><span class="o">=</span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="n">plotchar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">);</span><span class="w">
</span></code></pre>
</div>
<p><img src="https://sqlchoice.blob.core.windows.net/sqlchoice/static/images/Cluster_plot.JPG" alt="Plot of the clusters" /></p>

<p>Unfortunaltely, this plot does not really tell us anything about how the different clusters are different from each other. 
We had 4 different variables and we need to know something about the different characteristics of each cluster to make conclusions.</p>

<p>Using Kmeans is just a data mining method and you still need to spend time on analyzing the results. 
Depending on your data, you might need to use different methods to analyze the result. Here we just want to show that plotting can be one way.
Let’s try something else and see if we can get some more insight from that.</p>

<blockquote>
  <p>Now you have explored plotting as a method to evaluate the clusters.</p>
</blockquote>

<h2 id="step-26-analyze-cluster-means">Step 2.6 Analyze cluster means</h2>

<p>The clust object contains the results from our Kmeans clustering. We are going to look at some mean values.</p>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="c1">#Look at the clustering details and analyze results
</span><span class="n">clust</span><span class="w">
</span></code></pre>
</div>

<pre><code class="language-results">Call:
rxKmeans(formula = ~orderRatio + itemsRatio + monetaryRatio + 
    frequency, data = customer_returns, outFile = return_cluster, 
    outColName = "cluster", extraVarsToWrite = c("customer"), 
    overwrite = TRUE, numClusters = 4)
Data: customer_returns
Number of valid observations: 37336
Number of missing observations: 0 
Clustering algorithm:  
 
K-means clustering with 4 clusters of sizes 31675, 671, 2851, 2139
Cluster means:
   orderRatio   itemsRatio monetaryRatio frequency
1 0.000000000 0.0000000000    0.00000000  0.000000
2 0.007451565 0.0000000000    0.04449653  4.271237
3 1.008067345 0.2707821817    0.49515232  1.031568
4 0.000000000 0.0004675082    0.10858272  1.186068
Within cluster sum of squares by cluster:
         1          2          3          4 
    0.0000  1329.0160 18561.3157   363.2188 
    
</code></pre>

<p>Focusing on the cluster mean values, it seems like we can actually interpret something. 
Just to refresh our memory, here are the definitions of our variables:</p>

<ul>
  <li><em>frequency = return frequency</em></li>
  <li><em>orderRatio = return order ratio (total number of orders partially or fully returned versus the total number of orders)</em></li>
  <li><em>itemsRatio = return item ratio (total number of items returned versus the number of items purchased)</em></li>
  <li><em>monetaryRatio = return amount ratio (total monetary amount of items returned versus the amount purchased)</em></li>
</ul>

<p>Some examples of what the mean values tell us?</p>

<ul>
  <li>Well, cluster 1 (the largest cluster) seems to be a group of customers that are not active. All values are zero.
*And cluster 3 seems to be a group that stands out in terms of return behaviour.</li>
</ul>

<p>Data mining using Kmeans often requires further analysis of the results, and further steps to better understand each cluster, 
but it provides some very good leads. Cluster 1 is a set of customers who are clearly not active. Perhaps we can target marketing efforts towards this group to trigger an interest for purchases? 
Let’s query the database for their email addresses so that we can send a marketing email to them.</p>

<p>Use the following select statement to use the cluster data to select email addresses to customers in a specific cluster from te tables in SQL Server.</p>

<p>Open a new query in SSMS and run the following select statement:</p>

<div class="language-sql highlighter-rouge"><pre class="highlight"><code><span class="n">USE</span> <span class="p">[</span><span class="n">tpcxbb_1gb</span><span class="p">]</span>
<span class="k">SELECT</span> <span class="n">customer</span><span class="p">.[</span><span class="n">c_email_address</span><span class="p">],</span> <span class="n">customer</span><span class="p">.</span><span class="n">c_customer_sk</span>
  <span class="k">FROM</span> <span class="n">dbo</span><span class="p">.</span><span class="n">customer</span>
  <span class="k">JOIN</span> 
  <span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">return_cluster</span><span class="p">]</span> <span class="k">as</span> <span class="n">r</span>
  <span class="k">ON</span> <span class="n">r</span><span class="p">.</span><span class="n">customer</span> <span class="o">=</span> <span class="n">customer</span><span class="p">.</span><span class="n">c_customer_sk</span>
  <span class="k">WHERE</span> <span class="n">r</span><span class="p">.</span><span class="k">cluster</span> <span class="o">=</span> <span class="mi">3</span>
</code></pre>
</div>

<blockquote>
  <p>Congrats you just performed clustering with R! Let us now deploy our R code by moving it to SQL Server.</p>
</blockquote>

  </div>

   
    
    
      

      

      <a class="sql-page_steps-next"
        href="/en-us/sql-server/developer-get-started/ml-tutorials/R/customerclustering/step/3.html"
        target="_self">
        Go to step 3
      </a>

    
  

  <div class="sql-questions">
    <h2 class="sql-questions-title">
        Have Questions?
    </h2>
    <p class="sql-questions-text">
        Happy to help! You can find us on <a href="https://github.com/Microsoft/sql-server-samples/tree/master/samples/tutorials" target="_blank">GitHub</a>, <a href="https://social.msdn.microsoft.com/Forums/en-US/home target="_blank"">MSDN Forums</a>, and StackOverflow. We also monitor the <a href="https://twitter.com/search?q=%23SQLServerDev&amp;src=typd" target="_blank">#SQLServerDev</a> hashtag on Twitter.
    </p>
</div>

  
      <footer class="sql-disqus">
        

      </footer>
  
</article>

      </div>
    </main>

    <footer class="sql-footer">
  




    <div class="sql-footer-copy">
        <a class="sql-footer-link" href="https://go.microsoft.com/?linkid=2028325">Contact us</a> | 
        <a class="sql-footer-link" href="https://go.microsoft.com/fwlink/?LinkId=521839">Privacy & cookies</a> | 
        <a class="sql-footer-link" href="https://go.microsoft.com/fwlink/?LinkID=206977">Terms of use</a> | 
        <a class="sql-footer-link" href="https://www.microsoft.com/trademarks">Trademarks</a> | 
        <a class="sql-footer-link" href="https://choice.microsoft.com/">About our ads</a> | 
        © 2017 Microsoft 
      <!--
        <a href="#" target="_blank" class="sql-footer-icon fa fa-twitter" aria-hidden="true" style="float:right;"></a>
        <a href="#" target="_blank" class="sql-footer-icon fa fa-github" aria-hidden="true" style="float:right;"></a>
      -->
    </div>

           
</footer>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js" type="text/javascript"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.6.0/clipboard.min.js" type="text/javascript"></script>
<script src="https://use.fontawesome.com/c7b2a63f93.js"></script>
<script src="/en-us/sql-server/developer-get-started/ml-tutorials/assets/scripts/prism.js" type="text/javascript"></script>
<script src="/en-us/sql-server/developer-get-started/ml-tutorials/assets/scripts/steps.js" type="text/javascript"></script>
<script>
  ((window.gitter = {}).chat = {}).options = {
    room: 'Microsoft/mssql-developers'
  };
</script>
<script src="https://sidecar.gitter.im/dist/sidecar.v1.js" async defer></script>
  </body>

</html>
